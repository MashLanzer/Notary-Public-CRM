rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Users: only the user may read/write their profile doc
    // Users: only the user may read/write their profile doc
    match /users/{userId} {
      // Users may read/write their own profile. Admins may update other users (for role management).
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      
      // Allow user to manage their own subcollections (e.g. settings)
      match /{subcollection=**} {
        allow read, write: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      }
    }

    // Clients: only owner (creator) or admin can create/read/update/delete
    match /clients/{clientId} {
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow read: if isSignedIn() && (resource.data.ownerId == request.auth.uid || isAdmin());
      allow update, delete: if isSignedIn() && (resource.data.ownerId == request.auth.uid || isAdmin());
    }

    // Cases: accessible by owner/admin, OR publicly for the status portal
    match /cases/{caseId} {
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow read: if true; // Enabled for public status portal
      allow update, delete: if isSignedIn() && (resource.data.ownerId == request.auth.uid || isAdmin());
    }

    // Appointments: only owner or admin can access
    match /appointments/{appId} {
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow read, update, delete: if isSignedIn() && (resource.data.ownerId == request.auth.uid || isAdmin());
    }

    // Reminders: only owner or admin can access
    match /reminders/{reminderId} {
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow read, update, delete: if isSignedIn() && (resource.data.ownerId == request.auth.uid || isAdmin());
    }

    // Audit Logs: Authenticated users can write logs, only Admins can read
    match /audit_logs/{logId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
    }
  }
}
