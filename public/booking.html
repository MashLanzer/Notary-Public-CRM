<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Cita | Notaría Pública</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <link rel="stylesheet" href="styles.css">

    <style>
        .landing-nav {
            padding: 1rem 0;
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            border-bottom: 1px solid #e5e7eb;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            font-size: 1.25rem;
            color: #1e3a8a;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: #111827;
            font-weight: 500;
        }

        .booking-section {
            padding: 4rem 0;
            min-height: 80vh;
            background: #f9fafb;
        }

        .booking-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .calendar-panel {
            padding: 2rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            text-align: center;
        }

        .calendar-day-header {
            font-weight: 600;
            color: #6b7280;
            padding-bottom: 1rem;
            font-size: 0.875rem;
        }

        .calendar-day {
            padding: 1rem 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .calendar-day:hover:not(.disabled) {
            background-color: #eff6ff;
            color: #1e3a8a;
        }

        .calendar-day.selected {
            background-color: #1e3a8a;
            color: white;
        }

        .calendar-day.disabled {
            color: #d1d5db;
            cursor: not-allowed;
        }

        .calendar-day.today {
            font-weight: bold;
            border-color: #1e3a8a;
        }

        .info-panel {
            background: #f3f4f6;
            padding: 2rem;
            border-left: 1px solid #e5e7eb;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .time-slot {
            padding: 0.75rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .time-slot:hover:not(.disabled) {
            border-color: #1e3a8a;
            color: #1e3a8a;
        }

        .time-slot.selected {
            background: #1e3a8a;
            color: white;
            border-color: #1e3a8a;
        }

        .time-slot.disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        @media (max-width: 768px) {
            .booking-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <nav class="landing-nav">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    style="width:32px;height:32px;">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                <span>Notaría Pública</span>
            </a>
            <div class="nav-links">
                <a href="status.html">Consultar</a>
            </div>
        </div>
    </nav>

    <div class="booking-section">
        <div class="container">
            <h1 class="section-title text-center" style="margin-bottom: 2rem;">Agendar Cita</h1>

            <div class="booking-container">
                <div class="calendar-panel">
                    <div class="calendar-header">
                        <button class="btn btn-sm" id="prev-month">&lt;</button>
                        <h3 id="current-month-year">Enero 2026</h3>
                        <button class="btn btn-sm" id="next-month">&gt;</button>
                    </div>

                    <div class="calendar-grid" id="calendar-days">
                        <!-- Days injected via JS -->
                    </div>
                </div>

                <div class="info-panel">
                    <div id="selection-stage">
                        <h3 style="margin-bottom: 1rem;">Horarios Disponibles</h3>
                        <p class="text-xs text-muted" style="margin-bottom: 1rem;" id="selected-date-label">Selecciona
                            una fecha</p>

                        <div class="time-slots" id="time-slots">
                            <!-- Slots injected via JS -->
                        </div>

                        <div id="booking-form-container" style="display: none;">
                            <h4 style="margin-bottom: 1rem;">Sus Datos</h4>
                            <form id="public-booking-form">
                                <div class="form-group">
                                    <label class="form-label">Nombre Completo</label>
                                    <input type="text" class="form-input" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Teléfono</label>
                                    <input type="tel" class="form-input" name="phone" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" name="email" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tipo de Trámite</label>
                                    <select class="form-input" name="type">
                                        <option value="General">Consulta General</option>
                                        <option value="Notarization">Notarización General</option>
                                        <option value="Wills">Testamento / Fideicomiso</option>
                                        <option value="Power of Attorney">Poder Notarial (Power of Attorney)</option>
                                        <option value="Affidavit">Declaración Jurada (Affidavit)</option>
                                        <option value="Real Estate">Bienes Raíces / Escrituras</option>
                                        <option value="Apostille">Apostilla / Legalización</option>
                                        <option value="Marriage">Matrimonio Civil</option>
                                        <option value="Loan Signing">Cierre de Préstamo (Loan Signing)</option>
                                        <option value="Other">Otro Servicio</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary btn-block"
                                    style="margin-top: 1rem;">Confirmar Cita</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="firebase-init.js"></script>
    <script type="module">
        let currentDate = new Date();
        let selectedDate = null;
        let selectedTime = null;
        let appointments = [];
        let blockedDates = [];

        // Load appointments for the current month view
        async function loadAppointments() {
            if (!window.firebaseDB) {
                setTimeout(loadAppointments, 500);
                return;
            }
            try {
                const { collection, getDocs } = window.dbFuncs;
                const db = window.firebaseDB;

                // Fetch appointments
                const snapshot = await getDocs(collection(db, 'appointments'));
                appointments = snapshot.docs.map(doc => doc.data());

                // Fetch blocked dates
                try {
                    const blockedSnapshot = await getDocs(collection(db, 'blocked_dates'));
                    blockedDates = blockedSnapshot.docs.map(doc => doc.data().date);
                } catch (e) {
                    console.warn("Could not load blocked dates or collection empty", e);
                }

                renderCalendar();
            } catch (err) {
                console.error("Error loading data", err);
                // Fallback to render with what we have
                renderCalendar();
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-days');
            grid.innerHTML = '';

            const monthYear = document.getElementById('current-month-year');
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            monthYear.textContent = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

            // Day Headers
            ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'].forEach(d => {
                const el = document.createElement('div');
                el.className = 'calendar-day-header';
                el.textContent = d;
                grid.appendChild(el);
            });

            // Empty slots before first day
            for (let i = 0; i <firstDay.getDay(); i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Days
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = d;

                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                // Disable past days
                const checkDate = new Date(dateStr);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const isBlocked = blockedDates.includes(dateStr);

                if (checkDate <today || checkDate.getDay() === 0 || checkDate.getDay() === 6 || isBlocked) {
                    dayDiv.classList.add('disabled');
                    if (isBlocked) {
                        dayDiv.style.backgroundColor = '#fee2e2';
                        dayDiv.title = 'Día no disponible por el Notario';
                    }
                } else {
                    dayDiv.onclick = () => selectDate(dateStr, dayDiv);
                }

                if (selectedDate === dateStr) dayDiv.classList.add('selected');

                // Check if fully booked
                const daysAppts = appointments.filter(a => a.date === dateStr);
                if (daysAppts.length>= 8) dayDiv.classList.add('disabled');

                grid.appendChild(dayDiv);
            }
        }

        function selectDate(dateStr, el) {
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            selectedDate = dateStr;
            selectedTime = null;

            document.getElementById('selected-date-label').textContent = new Date(dateStr).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            renderTimeSlots(dateStr);
            document.getElementById('booking-form-container').style.display = 'none';
        }

        function renderTimeSlots(dateStr) {
            const container = document.getElementById('time-slots');
            container.innerHTML = '';

            const baseSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '15:00', '16:00', '17:00'];
            const takenTimes = appointments
                .filter(a => a.date === dateStr)
                .map(a => a.time);

            baseSlots.forEach(time => {
                const div = document.createElement('div');
                div.className = 'time-slot';
                div.textContent = time;

                if (takenTimes.includes(time)) {
                    div.classList.add('disabled');
                } else {
                    div.onclick = () => selectTime(time, div);
                }
                container.appendChild(div);
            });
        }

        function selectTime(time, el) {
            document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('selected'));
            el.classList.add('selected');
            selectedTime = time;
            document.getElementById('booking-form-container').style.display = 'block';
        }

        // Form Submit
        // Initialize EmailJS (You need to update these IDs with your own from emailjs.com)
        (function () {
            // https://dashboard.emailjs.com/admin/account
            emailjs.init("R_0WEyJF67aAZaSFF");
        })();

        // Global state for rescheduling
        let rescheduleId = null;

        document.getElementById('public-booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');

            if (!selectedDate || !selectedTime) return alert('Por favor seleccione fecha y hora');

            const formData = new FormData(e.target);
            const email = formData.get('email').toLowerCase().trim();
            const phone = formData.get('phone');
            const name = formData.get('name');
            const type = formData.get('type');

            btn.disabled = true;
            btn.textContent = 'Procesando...';

            try {
                const { addDoc, updateDoc, doc, collection, query, where, getDocs } = window.dbFuncs;
                const db = window.firebaseDB;

                // Prepare Data
                const appointmentData = {
                    clientName: name,
                    clientPhone: phone,
                    clientEmail: email,
                    type: type,
                    date: selectedDate,
                    time: selectedTime,
                    source: 'public_web',
                    status: 'scheduled',
                    lastUpdated: new Date().toISOString()
                };

                if (!rescheduleId) {
                    // --- NEW APPOINTMENT FLOW ---

                    // 1. Local Persistence Check
                    const lastBooking = localStorage.getItem('active_booking');
                    if (lastBooking) {
                        const booking = JSON.parse(lastBooking);
                        if (new Date(booking.date)>= new Date().setHours(0, 0, 0, 0) && booking.status !== 'cancelled') {
                            alert('Ya tienes una cita pendiente. No puedes agendar otra hasta completarla.');
                            btn.disabled = false;
                            btn.textContent = 'Confirmar Cita';
                            return;
                        }
                    }

                    // 2. Server-side Duplicate Check
                    const todayStr = new Date().toISOString().split('T')[0];
                    const q = query(collection(db, 'appointments'), where('clientEmail', '==', email));
                    const snapshot = await getDocs(q);
                    const hasActive = snapshot.docs.some(doc => {
                        const data = doc.data();
                        return data.date>= todayStr && data.status !== 'cancelled';
                    });

                    if (hasActive) {
                        alert('Ya existe una cita activa asociada a este correo electrónico.');
                        btn.disabled = false;
                        btn.textContent = 'Confirmar Cita';
                        return;
                    }

                    appointmentData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'appointments'), appointmentData);

                } else {
                    // --- RESCHEDULE FLOW ---
                    const apptRef = doc(db, 'appointments', rescheduleId);
                    appointmentData.status = 'rescheduled';
                    appointmentData.rescheduledFrom = new Date().toISOString(); // Audit trail

                    await updateDoc(apptRef, appointmentData);
                    alert('Su cita ha sido reprogramada exitosamente.');
                }

                // Send Email Notification
                try {
                    await emailjs.send(
                        "service_3w3frii",
                        "template_r2kb23k",
                        {
                            to_email: email,
                            to_name: name,
                            date: selectedDate,
                            time: selectedTime,
                            type: type,
                            message: rescheduleId
                                ? `Su cita ha sido REPROGRAMADA para el ${selectedDate} a las ${selectedTime}.`
                                : `Su cita ha sido confirmada para el ${selectedDate} a las ${selectedTime}.`
                        }
                    );
                } catch (emailErr) {
                    console.warn('Email sending failed:', emailErr);
                }

                // Persistence
                localStorage.setItem('active_booking', JSON.stringify({
                    date: selectedDate,
                    email: email,
                    status: 'scheduled'
                }));

                // Success UI
                const container = document.querySelector('.booking-container');
                container.innerHTML = `
                    <div style="padding: 4rem; text-align: center; color: #1e3a8a; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; max-width: 600px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 64px; height: 64px; margin-bottom: 1.5rem; color: #10b981;">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <h2 style="font-size: 2rem; margin-bottom: 1rem;">${rescheduleId ? '¡Cita Reprogramada!' : '¡Cita Confirmada!'}</h2>
                        <p style="font-size: 1.1rem; color: #4b5563; margin-bottom: 2rem;">
                            Hemos agendado tu cita para el <strong>${selectedDate}</strong> a las <strong>${selectedTime}</strong>.<br>
                            Se ha enviado un detalle a <strong>${email}</strong>.
                        </p>
                        <a href="landing.html" class="btn btn-primary">Volver al Inicio</a>
                    </div>
                `;

            } catch (err) {
                console.error(err);
                alert('Hubo un error al procesar tu solicitud.');
                btn.disabled = false;
                btn.textContent = rescheduleId ? 'Reprogramar Cita' : 'Confirmar Cita';
            }
        });

        // Initialize Reschedule Mode if param exists
        async function checkReschedule() {
            const params = new URLSearchParams(window.location.search);
            const rId = params.get('reschedule');

            if (rId && window.firebaseDB) {
                try {
                    const { doc, getDoc } = window.dbFuncs;
                    const snap = await getDoc(doc(window.firebaseDB, 'appointments', rId));
                    if (snap.exists()) {
                        const data = snap.data();
                        rescheduleId = rId;

                        // Show banner
                        const container = document.querySelector('.booking-section .container');
                        const banner = document.createElement('div');
                        banner.style.background = '#e0f2fe';
                        banner.style.border = '1px solid #7dd3fc';
                        banner.style.padding = '1rem';
                        banner.style.marginBottom = '2rem';
                        banner.style.borderRadius = '0.5rem';
                        banner.style.textAlign = 'center';
                        banner.style.color = '#0369a1';
                        banner.innerHTML = `<strong>Modo Reprogramación:</strong> Estás moviendo tu cita original del <u>${data.date}</u>. Por favor elige una nueva fecha.`;
                        container.insertBefore(banner, container.firstChild);

                        // Pre-fill form
                        document.querySelector('input[name="name"]').value = data.clientName || '';
                        document.querySelector('input[name="phone"]').value = data.clientPhone || '';
                        document.querySelector('input[name="email"]').value = data.clientEmail || '';
                        document.querySelector('select[name="type"]').value = data.type || 'General';

                        // Lock email/name to prevent identity switch during reschedule? 
                        // Optional, but safer.
                        document.querySelector('input[name="email"]').readOnly = true;

                    }
                } catch (e) {
                    console.error("Error fetching appointment for reschedule", e);
                }
            } else if (rId && !window.firebaseDB) {
                setTimeout(checkReschedule, 500);
            }
        }

        checkReschedule();

        // Navigation listeners
        document.getElementById('prev-month').onclick = () => {
            currentDate.setMonth(currentDate.getMonth()-1);
            renderCalendar();
        };
        document.getElementById('next-month').onclick = () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        };

        // Init
        loadAppointments();
    </script>
    <script>
        // Check for service parameter in URL
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const serviceParam = urlParams.get('service');

            if (serviceParam) {
                const select = document.querySelector('select[name="type"]');
                if (select) {
                    // Try to find exact match
                    let match = Array.from(select.options).find(opt => opt.value === serviceParam);
                    if (match) {
                        select.value = serviceParam;
                    }
                }
            }
        });
    </script>
</body>

</html>