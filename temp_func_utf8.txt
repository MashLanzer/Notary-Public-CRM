    async generatePDF() {
        if (!window.jspdf) return alert('Librería PDF no cargada. Por favor recarga la página.');

        const btn = document.getElementById('generate-pdf-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generando PDF...';
        btn.disabled = true;

        try {
            const { jsPDF } = window.jspdf;

            // Standard A4 dimensions in points: 595.28 x 841.89
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'pt',
                format: 'a4'
            });

            const source = document.getElementById('doc-preview');
            const clone = source.cloneNode(true);

            // Optimized dimensions for A4 at 1:1.33 scale (Standard for 96dpi to 72pt conversion)
            const viewportWidth = 800;

            // Apply strict, clean styles to the clone
            Object.assign(clone.style, {
                width: viewportWidth + 'px',
                padding: '50px 70px', // Professional print margins
                boxSizing: 'border-box',
                margin: '0',
                background: '#ffffff',
                color: '#000',
                fontSize: '11pt',
                fontFamily: '"Times New Roman", Times, serif',
                boxShadow: 'none',
                border: 'none',
                position: 'relative',
                display: 'block',
                lineHeight: '1.5',
                overflow: 'hidden' // Force containment
            });

            // Deep clean all child elements for a perfect print
            clone.querySelectorAll('*').forEach(el => {
                el.removeAttribute('contenteditable');
                el.style.maxWidth = '100%';
                el.style.boxSizing = 'border-box';

                if (el.classList.contains('sig-zone')) {
                    el.style.border = 'none';
                    el.style.borderBottom = '1px solid #000';
                    el.style.background = 'transparent';
                    el.style.height = '60px';
                    el.style.width = '100%';
                }

                if (el.classList.contains('notary-seal-placeholder')) {
                    el.style.border = '1px solid #000';
                }

                if (el.classList.contains('doc-body-text')) {
                    el.style.background = 'transparent';
                    el.style.border = '1px solid #eee';
                    el.style.margin = '20px 0';
                }

                // Remove shadows/weird web effects
                el.style.boxShadow = 'none';
                el.style.textShadow = 'none';
            });

            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            container.style.top = '0';
            container.style.width = viewportWidth + 'px';
            container.style.background = '#fff';
            container.appendChild(clone);
            document.body.appendChild(container);

            await pdf.html(clone, {
                x: 0,
                y: 0,
                width: 595.28, // Map 800px to 595.28pt
                windowWidth: viewportWidth,
                margin: [0, 0, 0, 0],
                autoPaging: 'slice',
                html2canvas: {
                    scale: 1, // Using 1 for stability since we matched windowWidth
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                },
                callback: function (doc) {
                    const clientSearch = document.getElementById('doc-client-search');
                    const clientName = clientSearch ? clientSearch.value : 'Documento';
                    const filename = `Doc_${clientName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;

                    doc.save(filename);
                    document.body.removeChild(container);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    try { Toast.success('PDF Descargado', 'El documento se ha generado correctamente.'); } catch (e) { }
                }
            });

        } catch (err) {
            console.error('PDF Error:', err);
            btn.innerHTML = originalText;
            btn.disabled = true;
            setTimeout(() => { btn.disabled = false; }, 2000);
        }
    },
